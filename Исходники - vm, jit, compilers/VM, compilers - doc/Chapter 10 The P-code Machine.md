[Pascal Implementation](https://homepages.cwi.nl/~steven/pascal/book/pascalimplementation.html) by Steven Pemberton and Martin Daniels

The P-code machine is similar to a conventional computer in that it consists of a processor and a memory. A major difference is that many operations performed by the processor involve the stack which is part of memory. For example a procedure call entails manipulating various factors such as parameters and return addresses and these are held on the stack. The machine instructions, called P-code, are stored in the memory and accessed in the normal manner.

The processor has a defined instruction set (detailed later) as well as five registers which have distinct functions for controlling the instructions and the stack areas within the memory.

The registers are:

-   `PC` the program counter;
-   `SP` the stack pointer
-   `MP` the mark stack pointer;
-   `NP` the new pointer;
-   `EP` the extreme stack pointer.

The program counter, `PC`, is a pointer to the current instruction being executed. The other registers are used to control the remaining area of memory - the data store.

The data store is divided into three areas as shown in Fig. 10.1.

![](data:image/gif;base64,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)  
Fig. 10.1

The constants area is generated by the assembler and accessed by the code (details may be found in the next chapter)

The heap grows towards the low-numbered locations of store and free heap space is pointed at by the `NP` pointer. Data is put onto the heap during a call to the new procedure and removed by using mark and release. The stack area has a further internal structure and is used to hold stack frames. A stack frame is generated and placed on the stack each time a procedure or function is called (in the following section, except where explicitly stated, references to procedures also include functions.) The first stack frame is the exception in that this belongs to the program block. The stack frames on the stack are shown in Fig. 10.2.

![](data:image/gif;base64,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)  
Fig. 10.2

### The Structure of Stack Frames

The stack frame format with its associated registers is shown in Fig 10.3.

![](data:image/gif;base64,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)  
Fig. 10.3

The mark stack pointer, `MP`, points to the base of the topmost stack frame and is used to regain the stack space when the execution of a procedure is complete and as a base to access local variables. The extreme stack pointer, `EP`, points to the top of the current stack frame. It protects the stack frame from `NP`, so that `SP` does not have to be checked each time it is incremented, and it also marks the point where a new stack frame can be placed should a procedure be called from the current one. The maximum possible size of each stack frame is known at compile time and this is reflected by the value of `EP`.

The local stack is used for holding temporary values during the execution of a procedure. For example the `SBI` instruction takes the two values from the top of this stack, subtracts them and returns this value back to the stack. The stack pointer will be adjusted to reflect the fact that there is now one value less on the stack.

The locals area is used for variables that have been declared within a procedure and therefore whose scope is local. For example consider the following procedure and the corresponding P-code:

```
program locals(input, output);
    procedure addlocal;
    var i: integer; (*The variable i is local to the procedure addlocal*)
    begin
i:=i+1
    end; (*of addlocal*)
begin
    addlocal
end.
```

```
L 3        Start of addlocal
 ENT 1 L 4
 ENT 2 L 5
 LODI 0 5  The variable i retrieved from the first location above the mark stack i.e. 5
 LDCI 1
 ADI       i+1
 STRI 0 5  New value of i is stored back in 5
 RETP      End of addlocal
L 4= 6
L 5= 7
L 6
I 10
ENT 1 L 7
ENT 2 L 8
 MST 0
 CUP 0 L 3 Procedure addlocal is called
 RETP
L 7= 9
L 8= 5
 Q
 I0
 MST 0
 CUP 0 L 6 Main program block is entered
 STP
 Q
```

The parameters area is used for transferring procedure parameters from the calling block; it is an address if the parameter is a 'call-by-reference' otherwise it is the value itself. The following example illustrates how parameters are passed:

```
 
program params(input, output);
var j: integer;

procedure addparam(var i: integer);
begin
    i:=i+1
end; (*of addparam *)

begin
    j:=1;
    addparam (j)
end.
```

```
L 3
 ENT 1 L 4
 ENT 2 L 5
 LODA 0 5
 LODA 0 5  The address of i
 INDI 0    Load indirect the contents of i
 LDCI 1
 ADL
I 10
 STOI
 RETP
L 4= 6
L 5= 8
L 6
 ENT 1 L 7
 ENT 2 L 8
 LDCI 1
 SROI 9
 MST 0
 LAO 9     Address of j, to be used as a parameter
 CUP 1 L 3 Call to addparam
 RETP
L 7= 10
L 8= 6
 Q

I0
 MST 0
 CUP 0 L 6
 STP
 Q
```

The _mark stack_ carries the administrative details for executing and returning from a procedure and for maintaining the necessary links to access variables in outer levels:

-   the _function value_ is simply an area used for returning the function value to the calling block and so is only used by functions; in practice this area must be capable of holding the largest possible value that may be returned by a function;
-   the _static link_ is used as a pointer to access variables in outer blocks; it points to the base of the stack frame of the procedure that textually encloses it;
-   the _dynamic link_ is the previous `MP` value so that the current stack frame may be removed when the execution of the called procedure is complete;
-   the _previous EP value_ is similarly used for resetting the `EP` register when this procedure returns;
-   the _return address_ enables program control to be returned to the calling procedure.

The following example program contains a nested recursive procedure and the schematic diagram shows the static and dynamic links on the stack at the time the program halts. The static link of a procedure will always point to the stack frame of the textually enclosing procedure (q will always point to p, p will always point to the program); the dynamic link will always point to the stack frame of the calling procedure (in this example, q will point sometimes to p and sometimes to q):

```
program main(input,output);
 var j: integer;

procedure p;
    var i: integer;

procedure q;
begin
    if i > 0 then begin
        i:=i-1; j := j+1;
        q (*procedure q is called recursively here*)
    end
    else write(input, 0) (*execution error to halt program*)
end;

begin
    i:=2;
    q
end;

begin
    j := 0;
    p
end.
```

![](data:image/gif;base64,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)  
Fig. 10.4

If p were called recursively before calling q, the static links of q would then point to the most recent stack frame of **p**.

### Instructions for calling procedures and functions

There are three P-code instructions for building stack frames, `MST` and `CUP` are used before entering the procedure and `ENT` is used for the first two instructions within the procedure. The detailed operation of these instructions is as follows.

A typical calling sequence is

```
 
 MST 0
 [code to load parameters]
 CUP 0 L 3
```

The operand of the `MST` (mark stack) instruction is an indication of the depth of nesting of the given procedure and is defined as "one plus the level of the calling procedure minus the level of the called procedure". This is used for calculating the static link. In the above example, when the program calls p is will use `MST 0`; when p calls q it will also use a `MST 0`; when q calls itself, it will use `MST 1`.

`MST 0` means: the static link is the stack frame that called you; `MST 1` means the static link is the static link of the stack frame that called you; `MST 2` would use the static link of that frame, and so on.

The execution of `MST` creates values for the static and dynamic links and saves the `EP`. As just explained, it assigns the value of the static link to point to the stack frame of the procedure that textually encloses this one. The dynamic link is assigned the current value of the mark stack pointer and the current value of the extreme stack pointer is stored. The stack pointer is incremented so as to point at the parameter area. This is in readiness for subsequent instructions which may load parameters.

The `CUP` (call user procedure) instruction sets the new value of `MP` and the link for the return address and finally causes the jump to the procedure concerned.

At the start of the procedure there are two `ENT` instructions which define the overall size of the stack frame and adjust `SP` and `EP` accordingly.

```
 
 ENT 1 L 7
 ENT 2 L 8
```

The labels `L 7` and `L 8` point to the values to be used by the `ENT` instructions.

The procedure execution may now proceed. At conclusion of the procedure, the `RET` (return) instruction provides the mechanism for returning to the calling procedure and removing stack frames.

The 'main' program block is handled in the same way as procedures as regards the stack, except that there are four locations reserved above the mark stack for files. These locations have fixed addresses as shown in Fig. 10.5, and are manipulated in the same way as global variables. The files may be regarded as parameters to the program.

![](data:image/gif;base64,R0lGODdhZQJ5AKIAAAQCBJyenFxeXPz+/HR2dLy+vHx+fAAAACwAAAAAZQJ5AAAD/zi63P4wykmrvTjrzbv/YCiOZGmeaKqubOu+cCzPdG3feK7vfO//wKBwSCwaj8ikcslsOp/QqHRKrVqv2Kx2y+16v+CweEwum8/otHrNbrvf8Lh8Tq/b7/i8fs/v+/+AgYKDhIWGh4iJiouMjY6PkJGEAQCVAJKYmZo6lgABm6ChoikBBkMFBpU4BZ2Wn6upAAYFo7WglbNAqbk4lK0AtDeUpgOpr7bIj764PsY7BscDqDmqC9XJ2I2olcE6lNGrDQHgNNwKrMTZ6ovDO+hDwDm+tAbp6/eIlM+eseSwO75K4RuIiNWOSp9YeeoBjUe9hQQjDprG6ZICXz0s6mi4S/+ixz8BuuG4NoBkL3vC4hWT9bFlnXq0xjlUWVJjDl7UNCp0yTOOL5zeIL47yMOcApM9k95LRc9mL3812q2EqrQqslhAcWSFhUuk1a9gw4odS7as2bNo06pdy7at27dw48qdS7eu3bt4Tfzay7ev37+AAwseTLiw4cOIEytezLix48eQI0ueTLky5RVO80bKzOkHZ2pAPrcQrZkRaRuny4Verbo0ptStM7L2ARtFbdeFbsfQ/YJ379kyfOMGJHy0Z+BFaxQf3mc55uPQaStnDsm5Cuu2kRONTd20dtDRZXPvrgh7dunhk48nj8j8Cfcl4Mf/7kI+ezj2R+QPsZ8/feP/95X3H2oDErhegIT0B4KCHjDYYIHXIZiIgx1QuIGFF0KYAoYSisFhBh9eEKKIGp7XYW4l7paiigee+MeIFsBIgYwzrjifiwnaWJ+OO7aIIx80ThBkBEMSyaMIRf44RZIPMNmAk08e6Z+SgUDJgJVHSfmcj1TigWWW6IUp3gxfdplEmV+iqeUHZZp5hJpiqhcnDG26WQScY+YpZ3B2NremiXpuR2afQP75nqGHcvnINjUwuolo9Uw35wmOxohohnd04s8yulmiHFKbRRCpoqTyB6qR6dGZh0IoKRCLVxWceoFBHMjqCIy0ospBrh3wWlJ9nV6qQZ2hMdWAQsLZWoE+/7USywWMzOq6QbQdUPvraMGm+lsenrDEwDjKQhCuBBg1e4sM5UqbQbocsHstC+NaIyyIelxi1FE7LRCLLLQUoE871SwjwS4GteKqJTht421NF3laHQSMMjrPOfr0c1Q1Dhss7gIK85Ixxp1IUzFCF1v0scPvTuDvJRaLfIlUKwETL5gWrBzzKzZTIsC/C1taahsvLzzNNcZi5AoqplSDClXF9JvKxfrGk663VFu0tCSfeeqKNCAvpFC/Sl+jrEYsfc211WKTTbLZ+ebL8JUxrm3O0aMaGwsGncodD910tyqkpF5eHExDRKst+JWXoALrk8HQWrg1Fhk7ALOqKP4akf8mGw51w8SkDfnfk6skleeblz665m/LG/cCp4tESeMzpxyrRq1DvnisgGfa8CuZO1AKyE92OztQSP3euwMIOZuFaMCXTlLzqY9der6kp2499NXTPKNN0JdufY14c3+89/T+zIbhAlk/DPVO4QKRBMimQ9L63UPuzOXijp899qhvfL3+/XseAD8Ht9UR0CQCxBuIxOe92EXJfGvQiDE8JkGI1E8V95vAT0p3P5DBCoPve1j+nBfAAZIPeYfbXPUSeEDUIVBEDPweC30GQ8Q1cDk0Ut6YkEXA6I1vc5ITVzAo58LIeYsi1QjiI5hnwtSxgndFBN39nkjCHjrRglEs4Oz/OIbFBmQwdry5BhX/V6Hc1YEV3ZiiUUiGEQKQxGwruV1JcoFEYCRtIRgJSSvAphIlNuIzX2PbGsv2tMMJrCYUadI5zFFIRIbOg50jpNpi8rFE3oYZjnLbIqWGMvDB0BSZFKMDtcinTIWMa7T4xdlMsYtT1qRynWRcRzjHR1bySxotCxkPRYi8vbwycz/phkI+ccvQbUV1uOwKFxdSzPVdLJjLJCYvnKk9IXWrmK7cpMyO6T8YQvOXJStODgm1B+uMEnf6Mc8lORRGC42TnNxi037kc04UGhBANYSXGeFJB+fAkQTw+WcZKyDQCM3qXhvaJz/l4JxsIimd9SSlBBya/1AYRpREEFzoGfC0p44KqpQa7ee8Hqot8AwqpCIt6Q046tFtoZShI53SpEwK0pfiJ6YLwmlOM2rTMLC0MypdqUJ7qoaf0rSlR1UVUd9g1JHolE1DXepGnzrQmTqVp1J9FlVrtVWuYjWrWmiqUINqoJOCtahdHVZa1frVs15BrGUNFFDN6tapkrWtW7KqPuuKBrhGdax6zStfy+BXvBo0sIcdLBkKS1ekXrWxivXpWhV4V8M+KLKLnSxGEWvZqmJWspWtqWMBK9rPeoGxpZ2rXHtkWjCglkWchWxvLEPb2tr2trjNrW53y9ve+va3wE1Ma4dL3OIa97jITa5yl8vc5h8697nQja50p0vd6lr3utjNrna3y93ueve74A2vGRIAADs=)  
Fig. 10.5

Thus the reference in a Pascal program to a file variable for example input^ , will be a direct reference to the contents of location 5.

### The P-Code Instruction Set

The following table describes the complete instruction set showing the parameters and the effect of the execution of each instruction on the stack. Only a brief description of each instruction is given here - a detailed version is given in the chapter on the interpreter.

| Instruction | Operation on stack | Parameters if present | Description of instruction |
| --- | --- | --- | --- |
|   | Before | After |   |   |
| ABI | (i) | i |   | Absolute value of integer |
| ABR | (r) | r |   | Absolute value of real |
| ADI | (i,i) | i |   | Adds two integers on the top of the stack and leaves an integer result |
| ADR | (r,r) | r |   | Adds two reals on the top of the stack and leaves a real result |
| CHKc | No change | PQ | Checks value is between upper and lower bounds |
| CHR | (i) | c |   | Converts integer to character |
| CSP | Special | Q | Call standard procedure |
| CUP | Special | PQ | Call user procedure |
| DECc | (x) | x | Q | Decrement |
| DIF | (s, s) | s |   | Set difference |
| DVI | (i,i) | i |   | Integer division |
| DVR | (r,r) | r |   | Real division |
| ENT | Special | PQ | Enter block |
| EOF | (a) | b |   | Test on end of file |
| EQUc | (x,x) | b | Q | Compare on equal |
| FJP | (b) |   |   | False jump |
| FLO | (i,r) | r,r |   | Float next to the top |
| FLT | (i) | r |   | Float top of the stack |
| GEQc | (x,x) | b | Q | Compare on greater or equal |
| INCc | (x) | x | Q | Increment |
| INDc | (a) | x | Q | Indexed fetch |
| INN | (i,s) | b |   | Test set membership |
| INT | (s,s) | s |   | Set intersection |
| IOR | (b,b) | b |   | Boolean inciusive OR |
| IXA | (a,i) | a | Q | Compute indexed address |
| LAO |   | a | Q | Load base level address |
| LCA |   | a | Q | Load address of constant |
| LCI |   | x | PQ | Load constant indirect - assembler generated |
| LDA |   | a | PQ | Load address with level P |
| LDCc |   | x | Q | Load constant |
| LDOc |   | x | Q | Load contents of base level address |
| LEQc | (x,x) | b | Q | Compare on less than or equal |
| LESc | (x,x) | b | Q | Compare on less than |
| LODc |   | x | PQ | Load contents of address |
| MOD | (i,i) | i |   | Modulo |
| MOV | (a,a) |   | Q | Move |
| MPI | (i,i) | i |   | Integer multiplication |
| MPR | (r,r) | r |   | Real multiplication |
| MST | Special | P | Mark stack |
| NEQc | (x,x) | b | Q | Compare on not equal |
| NGI | (i) | i |   | Integer sign inversion |
| NGR | (r) | r |   | Real sign inversion |
| NOT | (b) | b |   | Boolean not |
| ODD | (i) | b |   | Test on odd |
| ORDc | (x) | i |   | Convert to integer |
| RETc | Special |   | Return from block |
| SBI | (i,i) | i |   | Integer subtraction |
| SBR | (r,r) | r |   | Real subtraction |
| SGS | (i) | s |   | Generate singleton set |
| SQI | (i) | i |   | Squareinteger |
| SQR | (r) | r |   | Square real |
| SROc | (x) |   | Q | Store at base level address |
| STOc | (a,x) |   |   | Store at base level address |
| STP | 
No effect

 |   | Stop |
| STRc | (x) |   | PQ | Store at level P |
| TRC | (r) | i |   | Truncate |
| UJC | 

No effect

 |   | Error in case statement |
| UJP | 

No effect

 | Q | Unconditional jump |
| UNI | (s, s) | s |   | Set union |
| XJP | (i) |   | Q | Indexed jump |

Key to effect on stack:

a address  
b boolean  
c character  
i integer  
r real  
s set  
x any of the above types

The c in instruction names is a single character denoting one of the primitive types A, B, C, I, R, S, and matches the x in the effect column.

[Pascal Implementation](https://homepages.cwi.nl/~steven/pascal/book/pascalimplementation.html) by Steven Pemberton and Martin Daniels

Copyright © 1982, 2002 Steven Pemberton and Martin Daniels, all rights reserved.